<!DOCTYPE html>
<html>
    <head>
        <title> editor </title>
    </head>
    <body>
        <textarea id="input" style="width: 80vw; height: 30em">
Begin Facts:
    true()
    eq(L, cons(1, cons(2, cons(3, cons(4, nil)))))
End Facts

Begin Global:
    Rule SameLenBase:
    true()
    -----------------
    sameLength(nil, nil)

    Rule SameLenRec:
    sameLength(Xs, Ys)
    ------------------
    sameLength(cons(Xh, Xs), cons(Yh, Ys))

    Rule ContainsHead:
    true()
    ------------------
    contains(cons(X, Xs), X)

    Rule ContainsTail:
    contains(Xs, X)
    ---------------
    contains(cons(Y, Xs), X)

    Rule ContainsAllBase:
    true()
    ---------------------
    containsAll(nil, L2)

    Rule ContainsAllRec:
    and(contains(L2, X), containsAll(Xs, L2))
    -----------------------------------------
    containsAll(cons(X, Xs), L2)

    Rule AppendBase:
    true()
    ----------------
    append(nil, X, cons(X, nil))

    Rule AppendRec:
    append(Xs, X, Ys)
    -----------------
    append(cons(Xh, Xs), X, cons(Xh, Ys))

    Rule ReverseBase:
    true()
    -----------------
    reverseOf(nil, nil)

    Rule ReverseRec:
    and(reverseOf(Xs, Yp), append(Yp, Xh, Y))
    -----------------------------------------
    reverseOf(cons(Xh, Xs), Y)

    Rule Palindrome:
    reverseOf(X, X)
    ---------------
    palindrome(X)
End Global
        </textarea>
        <br/>
        <button id="reload">Reload</button>
        <span id="stages"></span>
        <br/>
        <label for="strategy-select">Strategy:</label>
        <select id="strategy-select">
            <option value="0">BFS</option>
            <option value="1">DFS</option>
        </select>
        <label for="max-steps-input">Max steps:</label>
        <input id="max-steps-input" type="number" value="10000" style="width: 80px"></input>
        <input id="query-input" type="text" value="and(containsAll(L, A), palindrome(A))" style="width: 300px"></input>
        <button id="query-btn">Query</button>
        <button id="next-btn" disabled>Next</button>
        <button id="stop-btn" disabled>Stop</button>
        <br/>
        <pre id="output"></pre>
        <script type="module">
            import module_loader from './langame.js';

            const Module = await module_loader({});
            window.Module = Module;

            let parse_module = Module.cwrap('parse_module', 'number', ['string']);
            window.parse_module = parse_module;

            let module_to_string = Module.cwrap('module_to_string', 'string', ['number']);
            window.module_to_string = module_to_string;

            let free_module = Module.cwrap('free_module', null, ['number']);
            window.free_module = free_module;

            let module_stage_count = Module.cwrap('module_stage_count', 'number', ['number']);
            let module_get_stage_name = Module.cwrap('module_get_stage_name', 'string', ['number', 'number']);

            let create_frontend = Module.cwrap('create_frontend', 'number', []);
            let free_frontend = Module.cwrap('free_frontend', null, ['number']);
            let frontend_load = Module.cwrap('frontend_load', 'number', ['number', 'string']);
            let frontend_query = Module.cwrap('frontend_query', 'string', ['number', 'string']);
            let frontend_fact_count = Module.cwrap('frontend_fact_count', 'number', ['number']);
            let frontend_rule_count = Module.cwrap('frontend_rule_count', 'number', ['number']);
            let frontend_stage_count = Module.cwrap('frontend_stage_count', 'number', ['number']);
            let frontend_stage_name = Module.cwrap('frontend_stage_name', 'string', ['number', 'number']);
            let frontend_set_strategy = Module.cwrap('frontend_set_strategy', null, ['number', 'number']);
            let frontend_get_strategy = Module.cwrap('frontend_get_strategy', 'number', ['number']);
            let frontend_set_max_steps = Module.cwrap('frontend_set_max_steps', null, ['number', 'number']);
            let frontend_get_max_steps = Module.cwrap('frontend_get_max_steps', 'number', ['number']);
            let frontend_query_start = Module.cwrap('frontend_query_start', 'string', ['number', 'string']);
            let frontend_query_next = Module.cwrap('frontend_query_next', 'string', ['number']);
            let frontend_has_more = Module.cwrap('frontend_has_more', 'number', ['number']);
            let frontend_query_stop = Module.cwrap('frontend_query_stop', null, ['number']);

            const reloadBtn = document.querySelector('#reload');
            const stagesSpan = document.querySelector('#stages');
            const inp = document.querySelector('#input');
            const out = document.querySelector('#output');
            const queryInput = document.querySelector('#query-input');
            const queryBtn = document.querySelector('#query-btn');
            const nextBtn = document.querySelector('#next-btn');
            const stopBtn = document.querySelector('#stop-btn');
            const strategySelect = document.querySelector('#strategy-select');
            const maxStepsInput = document.querySelector('#max-steps-input');

            let currentModule = null;
            let frontend = create_frontend();

            strategySelect.onchange = () => {
                frontend_set_strategy(frontend, parseInt(strategySelect.value));
            };

            maxStepsInput.onchange = () => {
                frontend_set_max_steps(frontend, parseInt(maxStepsInput.value) || 10000);
            };

            function buildStageButtons() {
                stagesSpan.innerHTML = '';
                const count = frontend_stage_count(frontend);
                for (let i = 0; i < count; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = frontend_stage_name(frontend, i);
                    btn.onclick = () => {
                        out.innerText += '\nStage: ' + btn.textContent + ' (stage execution not yet implemented)';
                    };
                    stagesSpan.appendChild(btn);
                }
            }

            reloadBtn.onclick = () => {
                if (currentModule) {
                    free_module(currentModule);
                }

                const code = inp.value;
                currentModule = parse_module(code);
                
                if (!currentModule) {
                    out.innerText = 'Parse error';
                    return;
                }

                const loadResult = frontend_load(frontend, code);
                if (loadResult !== 0) {
                    out.innerText = 'Load error';
                    return;
                }
                
                const factCount = frontend_fact_count(frontend);
                const ruleCount = frontend_rule_count(frontend);
                const stageCount = frontend_stage_count(frontend);
                
                out.innerText = 'Loaded: ' + factCount + ' facts, ' + ruleCount + ' global rules, ' + stageCount + ' stages';
                
                buildStageButtons();
            };

            function updateButtons() {
                const hasMore = frontend_has_more(frontend) !== 0;
                nextBtn.disabled = !hasMore;
                stopBtn.disabled = !hasMore;
            }

            queryBtn.onclick = () => {
                const queryStr = queryInput.value;
                if (!queryStr) return;
                frontend_query_stop(frontend);
                const result = frontend_query_start(frontend, queryStr);
                out.innerText += '\n\nQuery: ' + queryStr + '\n' + result;
                updateButtons();
            };

            nextBtn.onclick = () => {
                const result = frontend_query_next(frontend);
                out.innerText += '\n' + result;
                updateButtons();
            };

            stopBtn.onclick = () => {
                frontend_query_stop(frontend);
                out.innerText += '\n(stopped)';
                updateButtons();
            };
        </script>
    </body>
</html>
