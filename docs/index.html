<!DOCTYPE html>
<html>
    <head>
        <title> editor </title>
    </head>
    <body>
        <textarea id="input" style="width: 80vw; height: 30em">
Begin Facts:
    StateVar RunnerY
    StateVar RunnerVY
    StateVar ObstacleX
    eq(RunnerY, 0.0)
    eq(RunnerVY, 0.0)
    eq(ObstacleX, 30.0)
End Facts

Begin Global:
Rule ShouldJump:
    and(real_eq(RunnerY, 0.0), and(real_ge(ObstacleX, 8.0), real_le(ObstacleX, 18.0)))
    ---------------------------------------------------------------------------------
    shouldJump()

Rule RespawnObstacle:
    real_lt(ObstacleX, -3.0)
    ------------------------
    shouldRespawnObstacle()
End Global

Begin Stage Control:
    Begin State Constraints:
        or(
            and(shouldJump(), eq(next(RunnerVY), 3.5)),
            and(not(shouldJump()), eq(next(RunnerVY), RunnerVY))
        )
        or(
            and(shouldRespawnObstacle(), eq(next(ObstacleX), 30.0)),
            and(not(shouldRespawnObstacle()), real_sub(ObstacleX, 1.5, next(ObstacleX)))
        )
    End State Constraints
End Stage Control

Begin Stage Physics:
    Begin State Constraints:
        real_sub(RunnerVY, 0.5, NewVY)
        real_add(RunnerY, RunnerVY, NewY)
        or(
            and(real_gt(NewY, 0.0), and(eq(next(RunnerY), NewY), eq(next(RunnerVY), NewVY))),
            and(real_le(NewY, 0.0), and(eq(next(RunnerY), 0.0), eq(next(RunnerVY), 0.0)))
        )
    End State Constraints
End Stage Physics
        </textarea>
        <br/>
        <button id="reload">Reload</button>
        <span id="stages"></span>
        <br/>
        <div id="state-vars" style="margin: 10px 0; padding: 10px; background: #f0f0f0; font-family: monospace;"></div>
        <br/>
        <label for="strategy-select">Strategy:</label>
        <select id="strategy-select">
            <option value="0">BFS</option>
            <option value="1">DFS</option>
        </select>
        <label for="max-steps-input">Max steps:</label>
        <input id="max-steps-input" type="number" value="10000" style="width: 80px"></input>
        <input id="query-input" type="text" value="shouldJump()" style="width: 300px"></input>
        <button id="query-btn">Query</button>
        <button id="next-btn" disabled>Next</button>
        <button id="stop-btn" disabled>Stop</button>
        <br/>
        <pre id="output"></pre>
        <script type="module">
            import module_loader from './langame.js';

            const Module = await module_loader({});
            window.Module = Module;

            let parse_module = Module.cwrap('parse_module', 'number', ['string']);
            window.parse_module = parse_module;

            let module_to_string = Module.cwrap('module_to_string', 'string', ['number']);
            window.module_to_string = module_to_string;

            let free_module = Module.cwrap('free_module', null, ['number']);
            window.free_module = free_module;

            let module_stage_count = Module.cwrap('module_stage_count', 'number', ['number']);
            let module_get_stage_name = Module.cwrap('module_get_stage_name', 'string', ['number', 'number']);

            let create_frontend = Module.cwrap('create_frontend', 'number', []);
            let free_frontend = Module.cwrap('free_frontend', null, ['number']);
            let frontend_load = Module.cwrap('frontend_load', 'number', ['number', 'string']);
            let frontend_query = Module.cwrap('frontend_query', 'string', ['number', 'string']);
            let frontend_fact_count = Module.cwrap('frontend_fact_count', 'number', ['number']);
            let frontend_rule_count = Module.cwrap('frontend_rule_count', 'number', ['number']);
            let frontend_stage_count = Module.cwrap('frontend_stage_count', 'number', ['number']);
            let frontend_stage_name = Module.cwrap('frontend_stage_name', 'string', ['number', 'number']);
            let frontend_set_strategy = Module.cwrap('frontend_set_strategy', null, ['number', 'number']);
            let frontend_get_strategy = Module.cwrap('frontend_get_strategy', 'number', ['number']);
            let frontend_set_max_steps = Module.cwrap('frontend_set_max_steps', null, ['number', 'number']);
            let frontend_get_max_steps = Module.cwrap('frontend_get_max_steps', 'number', ['number']);
            let frontend_query_start = Module.cwrap('frontend_query_start', 'string', ['number', 'string']);
            let frontend_query_next = Module.cwrap('frontend_query_next', 'string', ['number']);
            let frontend_has_more = Module.cwrap('frontend_has_more', 'number', ['number']);
            let frontend_query_stop = Module.cwrap('frontend_query_stop', null, ['number']);
            let frontend_run_stage = Module.cwrap('frontend_run_stage', 'number', ['number', 'number']);
            let frontend_state_var_count = Module.cwrap('frontend_state_var_count', 'number', ['number']);
            let frontend_state_var_name = Module.cwrap('frontend_state_var_name', 'string', ['number', 'number']);
            let frontend_state_var_value = Module.cwrap('frontend_state_var_value', 'string', ['number', 'number']);

            const reloadBtn = document.querySelector('#reload');
            const stagesSpan = document.querySelector('#stages');
            const stateVarsDiv = document.querySelector('#state-vars');
            const inp = document.querySelector('#input');
            const out = document.querySelector('#output');
            const queryInput = document.querySelector('#query-input');
            const queryBtn = document.querySelector('#query-btn');
            const nextBtn = document.querySelector('#next-btn');
            const stopBtn = document.querySelector('#stop-btn');
            const strategySelect = document.querySelector('#strategy-select');
            const maxStepsInput = document.querySelector('#max-steps-input');

            let currentModule = null;
            let frontend = create_frontend();

            function updateStateVars() {
                const count = frontend_state_var_count(frontend);
                if (count === 0) {
                    stateVarsDiv.innerHTML = '<em>No state variables</em>';
                    return;
                }
                let html = '<strong>State Variables:</strong><br/>';
                for (let i = 0; i < count; i++) {
                    const name = frontend_state_var_name(frontend, i);
                    const value = frontend_state_var_value(frontend, i);
                    html += `  ${name} = ${value}<br/>`;
                }
                stateVarsDiv.innerHTML = html;
            }

            strategySelect.onchange = () => {
                frontend_set_strategy(frontend, parseInt(strategySelect.value));
            };

            maxStepsInput.onchange = () => {
                frontend_set_max_steps(frontend, parseInt(maxStepsInput.value) || 10000);
            };

            function buildStageButtons() {
                stagesSpan.innerHTML = '';
                const count = frontend_stage_count(frontend);
                for (let i = 0; i < count; i++) {
                    const stageIndex = i;
                    const btn = document.createElement('button');
                    btn.textContent = frontend_stage_name(frontend, i);
                    btn.onclick = () => {
                        const result = frontend_run_stage(frontend, stageIndex);
                        if (result === 1) {
                            out.innerText += '\nRan stage: ' + btn.textContent;
                            updateStateVars();
                        } else {
                            out.innerText += '\nStage failed: ' + btn.textContent;
                        }
                    };
                    stagesSpan.appendChild(btn);
                }
            }

            reloadBtn.onclick = () => {
                if (currentModule) {
                    free_module(currentModule);
                }

                const code = inp.value;
                currentModule = parse_module(code);
                
                if (!currentModule) {
                    out.innerText = 'Parse error';
                    return;
                }

                const loadResult = frontend_load(frontend, code);
                if (loadResult !== 0) {
                    out.innerText = 'Load error';
                    return;
                }
                
                const factCount = frontend_fact_count(frontend);
                const ruleCount = frontend_rule_count(frontend);
                const stageCount = frontend_stage_count(frontend);
                
                out.innerText = 'Loaded: ' + factCount + ' facts, ' + ruleCount + ' global rules, ' + stageCount + ' stages';
                
                buildStageButtons();
                updateStateVars();
            };

            function updateButtons() {
                const hasMore = frontend_has_more(frontend) !== 0;
                nextBtn.disabled = !hasMore;
                stopBtn.disabled = !hasMore;
            }

            queryBtn.onclick = () => {
                const queryStr = queryInput.value;
                if (!queryStr) return;
                frontend_query_stop(frontend);
                const result = frontend_query_start(frontend, queryStr);
                out.innerText += '\n\nQuery: ' + queryStr + '\n' + result;
                updateButtons();
            };

            nextBtn.onclick = () => {
                const result = frontend_query_next(frontend);
                out.innerText += '\n' + result;
                updateButtons();
            };

            stopBtn.onclick = () => {
                frontend_query_stop(frontend);
                out.innerText += '\n(stopped)';
                updateButtons();
            };
        </script>
    </body>
</html>
