<!DOCTYPE html>
<html>
    <head>
        <title> editor </title>
    </head>
    <body>
        <textarea id="input" style="width: 80vw; height: 30em">
Begin Facts:
    position(player, 0, 0)
End Facts

Begin Global:
End Global

Begin Stage Move:
End Stage Move
        </textarea>
        <br/>
        <button id="reload">Reload</button>
        <span id="stages"></span>
        <br/>
        <input id="query-input" type="text" placeholder="position(player, X, Y)" style="width: 300px"/>
        <button id="query-btn">Query</button>
        <br/>
        <pre id="output"></pre>
        <script type="module">
            import module_loader from './langame.js';

            const Module = await module_loader({});
            window.Module = Module;

            let parse_module = Module.cwrap('parse_module', 'number', ['string']);
            window.parse_module = parse_module;

            let module_to_string = Module.cwrap('module_to_string', 'string', ['number']);
            window.module_to_string = module_to_string;

            let free_module = Module.cwrap('free_module', null, ['number']);
            window.free_module = free_module;

            let module_stage_count = Module.cwrap('module_stage_count', 'number', ['number']);
            let module_get_stage_name = Module.cwrap('module_get_stage_name', 'string', ['number', 'number']);

            let create_frontend = Module.cwrap('create_frontend', 'number', []);
            let free_frontend = Module.cwrap('free_frontend', null, ['number']);
            let frontend_load = Module.cwrap('frontend_load', 'number', ['number', 'string']);
            let frontend_query = Module.cwrap('frontend_query', 'string', ['number', 'string']);
            let frontend_fact_count = Module.cwrap('frontend_fact_count', 'number', ['number']);
            let frontend_rule_count = Module.cwrap('frontend_rule_count', 'number', ['number']);
            let frontend_stage_count = Module.cwrap('frontend_stage_count', 'number', ['number']);
            let frontend_stage_name = Module.cwrap('frontend_stage_name', 'string', ['number', 'number']);

            const reloadBtn = document.querySelector('#reload');
            const stagesSpan = document.querySelector('#stages');
            const inp = document.querySelector('#input');
            const out = document.querySelector('#output');
            const queryInput = document.querySelector('#query-input');
            const queryBtn = document.querySelector('#query-btn');

            let currentModule = null;
            let frontend = create_frontend();

            function buildStageButtons() {
                stagesSpan.innerHTML = '';
                const count = frontend_stage_count(frontend);
                for (let i = 0; i < count; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = frontend_stage_name(frontend, i);
                    btn.onclick = () => {
                        out.innerText += '\nStage: ' + btn.textContent + ' (stage execution not yet implemented)';
                    };
                    stagesSpan.appendChild(btn);
                }
            }

            reloadBtn.onclick = () => {
                if (currentModule) {
                    free_module(currentModule);
                }

                const code = inp.value;
                currentModule = parse_module(code);
                
                if (!currentModule) {
                    out.innerText = 'Parse error';
                    return;
                }

                const loadResult = frontend_load(frontend, code);
                if (loadResult !== 0) {
                    out.innerText = 'Load error';
                    return;
                }
                
                const factCount = frontend_fact_count(frontend);
                const ruleCount = frontend_rule_count(frontend);
                const stageCount = frontend_stage_count(frontend);
                
                out.innerText = module_to_string(currentModule) + 
                    '\n\nLoaded: ' + factCount + ' facts, ' + ruleCount + ' global rules, ' + stageCount + ' stages';
                
                buildStageButtons();
            };

            queryBtn.onclick = () => {
                const queryStr = queryInput.value;
                if (!queryStr) return;
                const result = frontend_query(frontend, queryStr);
                out.innerText += '\n\nQuery: ' + queryStr + '\n' + result;
            };
        </script>
    </body>
</html>
